| comment "Define workspace and component lists"
| makeresults
| eval workspace_list="ws-prod,ws-dev"
| eval jobs_ws_prod="ingestion_job,transform_job"
| eval jobs_ws_dev="dev_job1"
| eval pipelines_ws_prod="bronze_to_silver"
| eval pipelines_ws_dev="dev_pipeline"
| eval warehouses_ws_prod="analytics_wh"
| eval warehouses_ws_dev="dev_wh"

| comment "Expand workspaces"
| eval workspace=split(workspace_list,",")
| mvexpand workspace

| comment "Root Service"
| append [
    | makeresults
    | eval service_name="Databricks"
    | eval parent_service=null()
    | eval service_type="Business"
    | table service_name parent_service service_type
]

| comment "Workspaces Container Node"
| append [
    | makeresults
    | eval service_name="Workspaces"
    | eval parent_service="Databricks"
    | eval service_type="Container"
    | table service_name parent_service service_type
]

| comment "Individual Workspace Services"
| appendpipe [
    | eval service_name="Workspace: ".workspace
    | eval parent_service="Workspaces"
    | eval service_type="Workspace"
    | table service_name parent_service service_type workspace
]

| comment "Top Domains under each Workspace"
| appendpipe [
    | eval domain_list=mvappend(
        "Control Plane Health",
        "Compute Plane",
        "Jobs & Workflows",
        "DLT Pipelines",
        "SQL Warehouses"
      )
    | mvexpand domain_list
    | eval service_name=domain_list." - ".workspace
    | eval parent_service="Workspace: ".workspace
    | eval service_type="Domain"
    | table service_name parent_service service_type workspace
]

| comment "Compute Plane Sub-Domains"
| appendpipe [
    | eval compute_list=mvappend(
        "Cluster Fleet",
        "Node Fleet",
        "Cloud Infra Dependencies"
      )
    | mvexpand compute_list
    | eval service_name=compute_list." - ".workspace
    | eval parent_service="Compute Plane - ".workspace
    | eval service_type="Sub-Domain"
    | table service_name parent_service service_type workspace
]

| comment "Workflow SLA Sub-Domain"
| appendpipe [
    | eval service_name="Workflow SLA (aggregated) - ".workspace
    | eval parent_service="Jobs & Workflows - ".workspace
    | eval service_type="Sub-Domain"
    | table service_name parent_service service_type workspace
]

| comment "Downstream BI Sub-Domain"
| appendpipe [
    | eval service_name="Downstream BI Consumers - ".workspace
    | eval parent_service="SQL Warehouses - ".workspace
    | eval service_type="Sub-Domain"
    | table service_name parent_service service_type workspace
]

| comment "Jobs under Jobs & Workflows"
| appendpipe [
    | eval job_list=case(
        workspace="ws-prod", split(jobs_ws_prod,","),
        workspace="ws-dev", split(jobs_ws_dev,",")
      )
    | mvexpand job_list
    | eval service_name="Job: ".job_list." - ".workspace
    | eval parent_service="Jobs & Workflows - ".workspace
    | eval service_type="Job"
    | table service_name parent_service service_type workspace
]

| comment "Pipelines under DLT Pipelines"
| appendpipe [
    | eval pipeline_list=case(
        workspace="ws-prod", split(pipelines_ws_prod,","),
        workspace="ws-dev", split(pipelines_ws_dev,",")
      )
    | mvexpand pipeline_list
    | eval service_name="Pipeline: ".pipeline_list." - ".workspace
    | eval parent_service="DLT Pipelines - ".workspace
    | eval service_type="Pipeline"
    | table service_name parent_service service_type workspace
]

| comment "Warehouses under SQL Warehouses"
| appendpipe [
    | eval warehouse_list=case(
        workspace="ws-prod", split(warehouses_ws_prod,","),
        workspace="ws-dev", split(warehouses_ws_dev,",")
      )
    | mvexpand warehouse_list
    | eval service_name="Warehouse: ".warehouse_list." - ".workspace
    | eval parent_service="SQL Warehouses - ".workspace
    | eval service_type="Warehouse"
    | table service_name parent_service service_type workspace
]

| comment "Finalize"
| dedup service_name
| table service_name parent_service service_type
